#!/bin/zsh
# shellcheck shell=bash

function calc() # Simple calculator
{
	local result="";
	result="$(printf "scale=10;$*\n" | bc --mathlib | tr -d '\\\n')";
	#                       └─ default (when `--mathlib` is used) is 20
	#
	if [[ "$result" == *.* ]]; then
		# improve the output for decimal numbers
		echo "$result" |
		sed -e 's/^\./0./'        `# add "0" for cases like ".5"` \
		    -e 's/^-\./-0./'      `# add "0" for cases like "-.5"`\
		    -e 's/0*$//;s/\.$//';  # remove trailing zeros
	else
		echo "$result";
	fi;
	ech0 "\n";
}

function has() # Check whether executable exists
{
    command -v "$1" >/dev/null 2>&1
}

function latest() # Show latest created file
{
    ls -lt -d "$1"/*/ | head -n1 | awk '{print $NF}'
}

function mkcd() # Create a new directory and enter it
{
  mkdir -p "$@"
  cd "$@" || exit
}

function cdls() # Show contents of the directory after changing to it
{
    builtin cd "$1" || exit
    ls -ACF
}

function backup() # Backup files and folders
{
	FILE=$1
	BACKUP_NAME="$FILE-[\"$(date + '%Y-%m-%d-%H:%M:%S')\"]"
	DIRECTORY="$HOME/backups"

	# Check if backup folder exists
	if [ ! -d "$DIRECTORY" ]; then
		mkdir "$DIRECTORY"
	fi

  	# check if passed argument is file or directory
	if [[ -d $FILE ]]; then
		echo "Creating backup of the directory: $FILE"
    	tar -czf "$DIRECTORY/$BACKUP_NAME.tar.gz" --exclude={"$FILE"/.venv,"$FILE"/node_modules} "$FILE"
	elif [[ -f $FILE ]]; then
		echo "Creating backup of the file: $FILE"
		cp -a "$FILE" "$DIRECTORY"
	else
		echo "$FILE is not valid format"
	fi
}

# Example: linecount js
function linecount() # Count lines of a file with specific extension
{
    find . -name "*.$1" | xargs wc -l
}

function sort_remove() # Sort and remove dublicates lines
{
    vi +'%!sort | uniq' +wq "$1"
}

function file_tolower() # Rename all items in a directory to lower case
{
    for i in *; do mv "$i" "${i,,}"; done
}

function file_toupper() # Rename all files in a directory to upper case
{
    for i in *; do mv "$i" "${i^^}"; done
}

function convert_datetime() # Convert DD/MM/YY date format to YYYY-MM-DD
{
    sed 's_\([0-9]\{1,2\}\)/\([0-9])'
}

function remove_newlines() # Remove new lines from files and folder
{
    rename 's/[\r\n]//g' *
}

function colormap() # Colormap
{
  for i in {0..255}; do print -Pn "%K{$i}  %k%F{$i}${(l:3::0:)i}%f " ${${(M)$((i%6)):#3}:+$'\n'}; done
}

function man() # Shows pretty man page
{
  env \
    LESS_TERMCAP_mb="$(printf '\e[1;31m')" \
    LESS_TERMCAP_md="$(printf '\e[1;31m')" \
    LESS_TERMCAP_me="$(printf '\e[0m')" \
    LESS_TERMCAP_se="$(printf '\e[0m')" \
    LESS_TERMCAP_so="$(printf '\e[1;44;33m')" \
    LESS_TERMCAP_ue="$(printf '\e[0m')" \
    LESS_TERMCAP_us="$(printf '\e[1;32m')" \
      man "$@"
}


function targz() # Targz a file
{
	local tmpFile="${@%/}.tar";
	tar -cvf "${tmpFile}" --exclude=".DS_Store" "${@}" || return 1;

	size=$(
		stat -f"%z" "${tmpFile}" 2> /dev/null; # macOS `stat`
		stat -c"%s" "${tmpFile}" 2> /dev/null;  # GNU `stat`
	);

	local cmd="";
	if (( size < 52428800 )) && hash zopfli 2> /dev/null; then
		# the .tar file is smaller than 50 MB and Zopfli is available; use it
		cmd="zopfli";
	else
		if hash pigz 2> /dev/null; then
			cmd="pigz";
		else
			cmd="gzip";
		fi;
	fi;

	echo "Compressing .tar ($((size / 1000)) kB) using \`${cmd}\`…";
	"${cmd}" -v "${tmpFile}" || return 1;
	[ -f "${tmpFile}" ] && rm "${tmpFile}";

	zippedSize=$(
		stat -f"%z" "${tmpFile}.gz" 2> /dev/null; # macOS `stat`
		stat -c"%s" "${tmpFile}.gz" 2> /dev/null; # GNU `stat`
	);

	echo "${tmpFile}.gz ($((zippedSize / 1000)) kB) created successfully.";
}

# Normalize `open` across Linux, macOS, and Windows.
# This is needed to make the `o` function (see below) cross-platform.
if [ ! "$(uname -s)" = 'Darwin' ]; then
	if grep -q Microsoft /proc/version; then
		# Ubuntu on Windows using the Linux subsystem
		alias open='explorer.exe';
	else
		alias open='xdg-open';
	fi
fi

function cheat() # Cheatsheet function
{
  curl cheat.sh/${@:-cheat}
  # curl cheat.sh/$@
}

function cview() # Read csv file
{
	csvtool readable "$1" | view -
}


function short() # Shorten url
{
   url=$1
   curl http://tinyurl.com/api-create.php\?url\="$url"
}

function kport() # Kill port
{
	kill "$(lsof -t -i:"$1")"
}

function lowerDir() # Lower case every file in current directory
{
	for i in *; do mv "$i" "${(L)i}"; done
}

function findEmpty() # Find empty files and directories in current directory
{
	find . -type f -exec bash -c 'if [ `cat "{}" |wc -w` -eq 0 ]; then echo "file - {}";fi' \; -or -empty -exec bash -c "echo dir - {}" \;
}

# from alex sexton:  gist.github.com/SlexAxton/4989674
function gifify() #
{
  if [[ -n "$1" ]]; then
	if [[ $2 == '--good' ]]; then
	  ffmpeg -i "$1" -r 10 -vcodec png out-static-%05d.png
	  time convert -verbose +dither -layers Optimize -resize 900x900\> out-static*.png  GIF:- | gifsicle --colors 128 --delay=5 --loop --optimize=3 --multifile - > "$1.gif"
	  rm out-static*.png
	else
	  ffmpeg -i "$1" -s 600x400 -pix_fmt rgb24 -r 10 -f gif - | gifsicle --optimize=3 --delay=3 > "$1.gif"
	fi
  else
	echo "proper usage: gifify <input_movie.mov>. You DO need to include extension."
  fi
}

function fzf-down() {
    fzf --height 50% "$@" --border
}

# Git functions

# fshow_preview - git commit browser with previews
function fshow() # git commit browser
{
  git log --graph --color=always \
      --format="%C(auto)%h%d %s %C(black)%C(bold)%cr" "$@" |
  fzf --ansi --no-sort --reverse --tiebreak=index --bind=ctrl-s:toggle-sort \
      --bind "ctrl-m:execute:
                (grep -o '[a-f0-9]\{7\}' | head -1 |
                xargs -I % sh -c 'git show --color=always % | less -R') << 'FZF-EOF'
                {}
FZF-EOF"
}

function gcbn() # Switch branch with fzf
{
  result=$(git branch -a --color=always | grep -v '/HEAD\s' | sort |
    fzf --height 50% --border --ansi --tac --preview-window right:70% \
      --preview 'git log --oneline --graph --date=short --pretty="format:%C(auto)%cd %h%d %s" $(sed s/^..// <<< {} | cut -d" " -f1) | head -'$LINES |
    sed 's/^..//' | cut -d' ' -f1)

  if [[ $result != "" ]]; then
    if [[ $result == remotes/* ]]; then
      git checkout --track $(echo "$result" | sed 's#remotes/##')
    else
      git checkout "$result"
    fi
  fi
}

function gstlf() # Git stash list with fzf
{
  local out sha q k
  while out=$(
    git stash list --pretty="%C(yellow)%h | %C(green)%cr %C(blue)%gs" |
    fzf-down --ansi --no-sort --query="$q" --print-query \
      --expect=ctrl-a,ctrl-b
  );
  do
    IFS=$'\n'; set -f
    res=($(<<< "$out"))
    unset IFS; set +f

    q="${res[0]}"
    k="${res[1]}"
    sha="${res[-1]}"
    sha="${sha%% *}"

    [[ -z "$sha" ]] && continue

    if [[ "$k" == 'ctrl-a' ]]; then
      git stash apply "$sha"
      break;
    elif [[ "$k" == 'ctrl-b' ]]; then
      git stash branch "stash-$sha" "$sha"
      break;
    else
      git diff "$sha"
    fi
  done
}

function worktree() # Worktree fzf
{
    worktree=$(
        git worktree list | fzf \
            --prompt="Switch Worktree: " \
            --height 40% --reverse |
            awk '{print $1}'
    )

    cd "$worktree" || return
}

function clone() # Clone repo and install dependencies
{
	git clone "$1"
	cd "$(basename "$_" .git)" || exit

	if test -f "./package.json"; then
		echo "Installing NPM dependencies.."
		npm install
		return 0
	elif test -f "./pyproject.toml"; then
		echo "Installing Poetry dependencies..."
        poetry init
		poetry install
		return 0
	elif test -f "./requirements.txt"; then
		python3 -m venv ./venv
		source venv/bin/activate
		pip install -r requirements.txt
		echo "Installing dependenciesfrom requirements.txt..."
		return 0
	elif test -f "./composer.json"; then
		echo "Installing composer dependencies..."
		composer install
		return 0
	fi

}

function ghexport() # Download single folder from github
{
	github_link=$1
	remove_path="/tree/master"
  	link="${github_link/$remove_path/trunk/}"
	svn export "${link}"
}

function clean-merged-branches() # Delete all merged branches
{
    git branch --merged | grep -v "\*" | xargs -n 1 git branch -d
}

function gacp() # Git: add all, commit and push. [-m "comment"]
{
	git add .
	git commit "$@"
	git push
}

function ggs() # push & commit with message `update`
{
    git add -A
    git commit -m 'update'
    git push
}

function git-https() # Git: Http to Https
{
	git remote set-url origin https://github.com/$(git remote get-url origin | sed 's/https:\/\/github.com\///' | sed 's/git@github.com://')
}

function git-ssh() # Git: Https to SSH
{
	git remote set-url origin git@github.com:$(git remote get-url origin | sed 's/https:\/\/github.com\///' | sed 's/git@github.com://')
}

function gitFind() # Search for a string in git log
{
    git log --all -S "$1"
}

function gitignore() # Get .gitignore file for specific lang
{
	curl -sL "https://www.gitignore.io/api/$@" >> .gitignore
}

# Source: https://github.com/wesbos/dotfiles/blob/master/.zshrc#L28
function touchh() { # Create file in a nested directory
  mkdir -p "$(dirname "$1")" && touch "$1"
}

function isup() # Check if URL is up
{
	local uri=$1

	if curl -s --head  --request GET "$uri" | grep "200 OK" > /dev/null ; then
		notify-send --urgency=critical "$uri is down"
	else
		notify-send --urgency=low "$uri is up"
	fi
}

function clean-comments() # remove comments (#, //) and empty lines
{
	sed -i.tmp "/^s*[#;//]/d;/^$/d" "$1"
}

function ssh-key() # generate ssh key with specific name
{
    name="$@"
    ssh-keygen -f ~/.ssh/"$name" -q -N ""
    eval "$(ssh-agent -s)"
    ssh-add ~/.ssh/"$name"
    xclip -selection clipboard < ~/.ssh/"$name".pub
    echo "public key copied to clipboard"
}

# Python
function server() # Start an HTTP server from a directory
{
	local port="${1:-8000}";
	sleep 1 && open "http://localhost:${port}/" &
	# Set the default Content-Type to `text/plain` instead of `application/octet-stream`
	# And serve everything as UTF-8 (although not technically correct, this doesn’t break anything for binary files)
	python3 -c $'import SimpleHTTPServer;\nmap = SimpleHTTPServer.SimpleHTTPRequestHandler.extensions_map;\nmap[""] = "text/plain";\nfor key, value in map.items():\n\tmap[key] = value + ";charset=UTF-8";\nSimpleHTTPServer.test();' "$port";
}

function python_venv() # Auto active virtual environment
{
  ENV=./venv
  # when you cd into a folder that contains $ENV
  [[ -d $ENV ]] && source $ENV/bin/activate > /dev/null 2>&1
  # when you cd into a folder that doesn't
  [[ ! -d $ENV ]] && deactivate > /dev/null 2>&1
}

function gpip() # Global PIP instllation
{
    PIP_REQUIRE_VIRTUALENV=false pip "$@"
}

function mkenv() # create python virtual environment
{
    python3 -m venv .venv
    source .venv/bin/activate

    # if requirements.txt exists, install dependencies
	if [[ -f "requirements.txt" ]]; then
		pip install -r requirements.txt
    fi

    # install base packages
    pip install \
        black \
        flake8 \
        isort \
        pylint
}

function prd() # Poetry reinstall package as dev dependencie
{
	poetry remove "$1"
	poetry add --dev "$1"
}

function dj-watch-coverage() # Watch for Django test changes and run coverage
{
    rg --files --type-add 'python3:*.py' --type python3 | entr -s "
    poetry run python manage.py test
    poetry run coverage combine
    poetry run coverage html --skip-covered
    poetry run coverage report --fail-under 100
    "
}

# Usage: json '{"foo":42}' or echo '{"foo":42}' | json
function json() # Format json string
{
	if [ -t 0 ]; then # argument
		python3 -mjson.tool <<< "$*" | pygmentize -l javascript;
	else
		python3 -mjson.tool | pygmentize -l javascript;
	fi
}

function token() # generate secret, token
{
	python3 -c 'import secrets; print(secrets.token_urlsafe(16))'
}

# ReactNative
function bapk() # build android apk (Must run inside react-native project)
{
    apk_path="./android/app/build/outputs/apk/debug"

	if [ ! -f package.json ]; then
		echo "package.json was not found. Run command inside root dir of your project."
		return 1
	fi

	if ! grep --quiet '"react-native":' package.json; then
		echo "Not a react-native project"
		return 1
	fi

	if [[ -d "./android/app/src/main" && ! -d "android/app/src/main/assets" ]]; then
		mkdir android/app/src/main/assets
	fi

	react-native bundle --platform android --dev false \
	                    --entry-file index.js \
	                    --bundle-output android/app/src/main/assets/index.android.bundle \
	                    --assets-dest android/app/build/intermediates/res/merged/release/ \
	                    && rm -rf android/app/src/main/res/drawable-* \
	                    && rm -rf android/app/src/main/res/raw/* \
	                    && cd android && ./gradlew assembleRelease && cd ..

	# open folder where apk file is stored
    xdg-open ${apk_path}
}

function rna() # clean cache & run react-native android simulator
{
    cd android && ./gradlew clean
    cd .. && react-native run-android
}

# Database related functions

# Postgres
function psql-create-db() # Create Postgres database
{
    db_name="$@"
    sudo -u postgres createdb "$db_name"
    sudo -u postgres psql -c "grant all privileges on database $db_name to $USER;" > /dev/null 2>&1
    echo "Database $db_name successfully created!"
}

function mysqldb() # MYSQL base commands (refresh, create, drop, list)
{
    if [ "$1" = "refresh" ]; then
        mysql -uroot -e "drop database $2; create database $2"
    elif [ "$1" = "create" ]; then
        mysql -uroot -e "create database $2"
    elif [ "$1" = "drop" ]; then
        mysql -uroot -e "drop database $2"
    elif [ "$1" = "list" ]; then
        mysql -uroot -e "show databases" | perl -p -e's/\|| *//g'
    fi
}

function removebg() # Remove background from the image
{
	curl -H "X-API-Key: $REMOVEBG_KEY" \
       -F "image_file=@$1" \
       -F "size=auto" \
       -f https://api.remove.bg/v1.0/removebg -o no-bg.png
}

function bash-file() # Create new shell file
{
  FILE_PATH=$1
  mkdir -p -- "$(dirname "$FILE_PATH")" && touch -- "$FILE_PATH"
  echo '#!/usr/bin/env bash' >> "$FILE_PATH"
  echo '' >> "$FILE_PATH"
  chmod +x "$FILE_PATH"
}

function makerun() # Run makefile command
{
  local makefile_commands
  makefile_commands=$(grep -E '^[a-zA-Z0-9_-]+:.*?## .*$$' Makefile | awk 'BEGIN {FS = ":.*?## "}{printf "%-30s %s\n", $1, $2}' | fzf --height 50% --ansi)

  if [[ -n "$makefile_commands" ]]; then
    local selected_command
    selected_command=$(echo "$makefile_commands" | awk '{print $1}')
    echo "Running 'make $selected_command'"
    make "$selected_command"
  else
    echo "Exit: No command selected."
  fi
}

function fnpm() # Run npm scripts interactively
{
    package_manager=$(_get_node_package_manager)  

    if [ -f "package.json" ]; then
        scripts=$(jq -r '.scripts | keys | .[]' package.json | fzf --height 50%)

        if [[ -n "$scripts" ]]; then
            script_name=$(echo "$scripts" | awk '{gsub(/"/, ""); print}')
            echo "Running $package_manager run $script_name"
            "$package_manager" run "$script_name"
        else
            echo "Exit: You haven't selected any script"
        fi
    else
        echo "Exit: package.json not found"
    fi
}

function repl() # Launch Repl for specified language
{
	lang=$1

	if [ "$lang" = "python" ]; then
		lang="python3"
	elif [ "$lang" = "node" ]; then
		lang="nodejs"
	elif [ "$lang" = "java" ]; then
		lang="java10"
	elif [ "$lang" = "c#" ]; then
		lang="csharp"
	fi

	python3 -m webbrowser "https://replit.com/languages/$lang" &

}

function lorem() # Generate Loremipsum text
{
	if [ "${1}" = "" ] || [ "${2}" = "" ]; then
		echo "Usage: loremipsum [paragraphs, sentences] [integer]"
	else
		curl -s "http://metaphorpsum.com/paragraphs/${1}/${2}" && printf "\n"
	fi
}

function dataurl() # Create a data URL from a file
{
    local mimeType
	mimeType=$(file -b --mime-type "$1");
	if [[ $mimeType == text/* ]]; then
		mimeType="${mimeType};charset=utf-8";
	fi
	echo "data:${mimeType};base64,$(openssl base64 -in "$1" | tr -d '\n')";
}

# Source: http://superuser.com/questions/611538/is-there-a-way-to-display-a-countdown-or-stopwatch-timer-in-a-terminal
function stopwatch() # Stopwatch, press enter to time.
{
	date1=$(date +%s);
	while :; do
		days=$(( $(($(date +%s) - date1)) / 86400 ))
		echo -ne "$days day(s) and $(date -u --date @$(($(date +%s) - $date1)) +%H:%M:%S)\r";
		sleep 0.1
	done
}

function pngtojpg() # Bulk convert png to jpg
{
	for i in *.png ; do convert "$i" "${i%.*}.jpg" ; done
}

function dockerlint() # Lint Dockerfile with Hadolint
{
  docker container run --rm -i \
    hadolint/hadolint hadolint --ignore DL3008 "${@}" - < Dockerfile
}

# C++ snippets
function cpp-run() # compile and run executable
{
    echo "Compiling file..."
    g++ -o "$1" "$1.cpp"
    ./"$1".cpp
}

function spy # Watch file
{
    file=$1
    echo "Watching file ${file} 👀..."
    while true; do
        watch -n 1 -g -x cat "${file}" > /dev/null 2>&1
        echo "File ${file} changed"
    done
}

function clean_deps # Remove node, python, php dependencies
{
    folders=("node_modules" "venv" ".env" "vendor")
    days=${1:-90}

    for folder in "${folders[@]}"
    do
         find ~/dev -name "$folder" -type d -maxdepth 4 -mtime +"$days" -exec rm -rf {} \;
    done
}

function clean_containers # Remove containers that were used N month ago
{
    days=${1:-90}
    hours=$((24 * days))
    echo $hours
    docker image prune --all --filter "until=4320h"
}

# Source: https://kittygiraudel.com/snippets/groom-dead-code/
function groom_dead_code # Check whether files & folders in a given directory are imported in JavaScript files
{
  root="${2:-.}"
  for entry in "$1"/*
  do
    name=$(basename "$entry")
    if [[ -z "$(grep -r "/$name'" "$root")" ]]; then
      echo "$entry is unused"
    fi
  done
}

# Source: https://kittygiraudel.com/snippets/groom-dependencies/
function groom_dependencies # Check for unused dependencies
{
  key=${1:-dependencies}
  for dep in $(cat package.json | jq -cr ".$key|keys|.[]");
  do [[ -z "$(grep -r  --exclude-dir=node_modules "'${dep}" .)" ]] && echo "$dep appears unused";
  done
}

function node-flush() # Reinstall node deps
{
    rm -rf node_modules/ build package.lock

    if [ -f "package-lock.json" ]; then
        npm i && npm start
    elif [ -f "yarn.lock" ]; then
        yarn install && yarn dev
    elif [ -f "pnpm-lock.yaml" ]; then
        pnpm install && pnpm start
    elses
        echo "Unable to determine the package manager"
    fi
}

# Get Node package manager
function _get_node_package_manager() {
    if [[ -f bun.lockb ]]; then
        echo "bun"
    elif [[ -f pnpm-lock.yaml ]]; then
        echo "pnpm"
    elif [[ -f yarn.lock ]]; then
        echo "yarn"
    elif [[ -f package-lock.json ]]; then
        echo "npm"
    else
        echo "pnpm"
    fi
}

function p() # Determine package manager and run command with it
{
  if [[ -f bun.lockb ]]; then
    command bun "$@"
  elif [[ -f pnpm-lock.yaml ]]; then
    command pnpm "$@"
  elif [[ -f yarn.lock ]]; then
    command yarn "$@"
  elif [[ -f package-lock.json ]]; then
    command npm "$@"
  else
    command pnpm "$@"
  fi
}

function install_latest_release # Download and install latest release from Github
{
    repo=$1
    url=https://api.github.com/repos/$repo/releases/latest
    download_url="$(curl -s "$url" \
        | grep "browser_download_url.*deb\"" \
        | cut -d : -f 2,"3 \"
        | tr -d \" \
        | xa"rgs)"
    filename=$(basename "$download_url")
    echo "Downloading file: $download_url"
    wget -q "$download_url"
    sudo dpkg -i "$filename"
    rm "$filename"
}

function upgrade-deps # Upgrade global dependencies
{
    npx npm-check --global --update-all
    pip3 install --upgrade pip
    pip3 freeze | grep -v "^\-e" | grep -v "@" | cut -d = -f 1 | xargs pip3 install -U
}

function timezsh() # Time ZSH load time
{
  shell=${1-$SHELL}
  for i in $(seq 1 10); do /usr/bin/time "$shell" -i -c exit; done
}

function nuke() # fzf kill process
{
  local pid
  pid=$(ps -ef | grep -v ^root | sed 1d | fzf -m | awk '{print $2}')

  if [ "x$pid" != "x" ]
  then
    echo "$pid" | xargs kill -"${1:-9}"
  fi
}

function djtest() # Run Django tests interactively with fzf
{
    test_path=$1
    test_file=$(echo "$test_path" | tr '/' '.' | sed 's/\.py$//')
    python "$DOTFILES/scripts/python/get_class_methods.py" "$test_path" \
        | fzf \
        | xargs -I {} poetry run python manage.py test "$test_file".{}
}
